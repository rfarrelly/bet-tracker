<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upcoming Fixtures</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-4">Upcoming Fixtures</h1>

        <!-- Filter Controls -->
        <div class="mb-4 flex space-x-4">
            <input type="text" id="filterDiv" placeholder="Division" class="p-2 border rounded">
            <input type="date" id="filterDate" class="p-2 border rounded">
            <input type="time" id="filterTime" class="p-2 border rounded">
            <button onclick="filterFixtures()" class="bg-blue-500 text-white p-2 rounded">
                Filter
            </button>
        </div>

        <!-- Betting Controls -->
        <div class="mb-4 flex space-x-4">
            <select id="betType" class="p-2 border rounded">
                <option value="single">Single</option>
                <option value="accumulator">Accumulator</option>
            </select>
            <input type="text" id="username" placeholder="Username" class="p-2 border rounded w-1/3">
            <input type="text" id="stake" placeholder="Stake" class="p-2 border rounded w-1/3">
            <button onclick="placeBet()" class="bg-green-500 text-white p-2 rounded">
                Place Bet
            </button>
        </div>

        <!-- Fixtures Table -->
        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <table class="min-w-full border-collapse">
                <thead class="bg-blue-500 text-white">
                    <tr>
                        <th class="p-2">Select</th>
                        <th class="p-2">Div</th>
                        <th class="p-2">Date</th>
                        <th class="p-2">Time</th>
                        <th class="p-2">Home</th>
                        <th class="p-2">Away</th>
                        <th class="p-2">B365 Home</th>
                        <th class="p-2">B365 Draw</th>
                        <th class="p-2">B365 Away</th>
                        <th class="p-2">Market</th>
                    </tr>
                </thead>
                <tbody id="fixturesTable">
                    {% for row in fixtures %}
                    <tr class="border-b">
                        <td class="p-2 text-center">
                            <input type="checkbox" class="fixture-checkbox" data-home="{{ row['home'] }}" data-away="{{ row['away'] }}">
                        </td>
                        <td class="p-2">{{ row['div'] }}</td>
                        <td class="p-2">{{ row['date'] }}</td>
                        <td class="p-2">{{ row['time'] }}</td>
                        <td class="p-2">{{ row['home'] }}</td>
                        <td class="p-2">{{ row['away'] }}</td>
                        <td class="p-2">{{ row['b365h'] }}</td>
                        <td class="p-2">{{ row['b365d'] }}</td>
                        <td class="p-2">{{ row['b365a'] }}</td>
                        <td class="p-2">
                            <select class="market-select p-1 border rounded">
                                <option value="home">Home</option>
                                <option value="draw">Draw</option>
                                <option value="away">Away</option>
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>                
            </table>
        </div>
    </div>

    <script>
        async function filterFixtures() {
            let div = document.getElementById("filterDiv").value;
            let dateInput = document.getElementById("filterDate").value;
            let time = document.getElementById("filterTime").value;

            let params = new URLSearchParams();
            if (div) params.append("div", div);

            let formattedDate = dateInput ? new Date(dateInput).toISOString().split("T")[0] : "";
            if (formattedDate) params.append("date", formattedDate);

            if (time) params.append("time", time);

            try {
                let response = await fetch(`http://127.0.0.1:5000/fixtures/api?${params.toString()}`);
                let fixtures = await response.json();

                let tableBody = document.getElementById("fixturesTable");
                tableBody.innerHTML = ""; // Clear existing rows

                fixtures.forEach(fixture => {
                    let row = document.createElement("tr");
                    row.classList.add("border-b");

                    row.innerHTML = `
                        <td class="p-2 text-center">
                            <input type="checkbox" class="fixture-checkbox" data-home="${fixture.home}" data-away="${fixture.away}">
                        </td>
                        <td class="p-2">${fixture.div || "N/A"}</td>
                        <td class="p-2">${fixture.date || "N/A"}</td>
                        <td class="p-2">${fixture.time || "N/A"}</td>
                        <td class="p-2">${fixture.home || "N/A"}</td>
                        <td class="p-2">${fixture.away || "N/A"}</td>
                        <td class="p-2">${fixture.b365h || "N/A"}</td>
                        <td class="p-2">${fixture.b365d || "N/A"}</td>
                        <td class="p-2">${fixture.b365a || "N/A"}</td>
                        <td class="p-2">
                            <select class="market-select p-1 border rounded">
                                <option value="home">Home</option>
                                <option value="draw">Draw</option>
                                <option value="away">Away</option>
                            </select>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error("Error fetching fixtures:", error);
            }
        }

        async function placeBet() {
            let betType = document.getElementById("betType").value;
            let username = document.getElementById("username").value;
            let stake = document.getElementById("stake").value;
            let selectedFixtures = [];

            let firstOdds = null;

            document.querySelectorAll(".fixture-checkbox:checked").forEach(checkbox => {
                let row = checkbox.closest("tr");
                let selectedMarket = row.querySelector("select").value; 

                let oddsCellIndex = selectedMarket === "home" ? 6 : selectedMarket === "draw" ? 7 : 8;
                let odds = parseFloat(row.children[oddsCellIndex].textContent.trim());  

                if (!firstOdds) firstOdds = odds;

                selectedFixtures.push({
                    home: checkbox.dataset.home,
                    away: checkbox.dataset.away,
                    market: selectedMarket,
                    odds: odds
                });
            });

            if (!username || selectedFixtures.length === 0 || !stake) {
                alert("Please enter a username, stake, and select at least one fixture.");
                return;
            }

            let betData = {
                user_id: username,
                bet_type: betType,
                stake: parseFloat(stake),
                odds: firstOdds,
                selections: selectedFixtures
            };

            console.log("ðŸ”¹ Sending Bet Data:", betData);

            try {
                let response = await fetch("http://127.0.0.1:5000/bets", {  // Change `/bets/place` to `/bets/`
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(betData)
                });

                if (response.ok) {
                    alert("Bet placed successfully!");
                } else {
                    alert("Error placing bet.");
                }
            } catch (error) {
                console.error("API Error:", error);
                alert("Failed to connect to the server.");
            }
        }
    </script>
</body>
</html>
